<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FootballPro • Dashboard</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg1:#052e1a; --bg2:#0b3f24; --bg3:#0f5130;
      --panel:rgba(6,78,59,.45);
      --line:rgba(16,185,129,.22);
      --line-strong:rgba(16,185,129,.35);
      --fg:#ecfdf5; --muted:#a7f3d0;
      --glass:rgba(6,78,59,.55);
      --pri1:#22c55e; --pri2:#16a34a; --priB:#34d399;
      --ink:#052e1a;
      --panel-2:#063a2b;
      --shadow:rgba(0,0,0,.4);
      --chip-bg:rgba(6,78,59,.55);
      --chip-border:rgba(16,185,129,.28);
      --card-top-1:#064e3b; --card-top-2:#065f46;
      --search-bg:#1b3b32;
      --gold:#fde047;
    }
    [data-theme="light"]{
      --bg1:#e8fff4; --bg2:#e6fff2; --bg3:#e2ffee;
      --panel:#ffffff; --panel-2:#f5fff9;
      --line:#d2f5e6; --line-strong:#b8eedb;
      --fg:#062e22; --muted:#256d57; --glass:#ffffff;
      --pri1:#16a34a; --pri2:#22c55e; --priB:#059669;
      --ink:#ffffff; --shadow:rgba(0,0,0,.08);
      --chip-bg:#f0fff8; --chip-border:#b8eedb;
      --card-top-1:#ccf7e6; --card-top-2:#d8faee;
      --search-bg:#f1fff8;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body,input,button,select,textarea{font-family:'Inter',sans-serif}
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));color:var(--fg);min-height:100vh;overflow-x:hidden;padding-bottom:78px}

    /* Header */
    .header{position:sticky;top:0;z-index:100;background:rgba(3,31,20,.65);backdrop-filter:blur(14px);border-bottom:1px solid var(--line-strong)}
    [data-theme="light"] .header{background:rgba(255,255,255,.7)}
    .header-content{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .logo{font-weight:800;font-size:20px;background:linear-gradient(135deg,var(--pri1),#4ade80);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    .searchbar{position:relative;display:flex;gap:8px;align-items:center;flex:1;max-width:640px}
    .searchbar input{flex:1;padding:.8rem 1rem .8rem 2.3rem;background:var(--search-bg);border:1px solid var(--line-strong);border-radius:14px;color:var(--fg);transition:.2s}
    .searchbar input:focus{outline:none;border-color:var(--priB);box-shadow:0 0 0 3px rgba(52,211,153,.15)}
    .searchbar .icon{position:absolute;left:.8rem;opacity:.8}
    .btn{padding:.65rem 1rem;border-radius:12px;border:1px solid var(--line-strong);background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);font-weight:800;cursor:pointer;transition:.18s}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:var(--panel-2);color:var(--fg)}

    .ac{position:absolute;top:110%;left:0;right:0;background:var(--panel);border:1px solid var(--line-strong);border-radius:10px;box-shadow:0 18px 40px var(--shadow);display:none;max-height:240px;overflow:auto;z-index:30}
    .ac.show{display:block}
    .ac-item{padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer;border-bottom:1px solid var(--line)}
    .ac-item:last-child{border-bottom:none}
    .ac-item:hover{background:var(--panel-2)}
    .ac-pos{font-size:12px;opacity:.8}

    .auth-area{display:flex;align-items:center;gap:10px}
    .auth-link{padding:.5rem .85rem;border-radius:12px;border:1px solid var(--chip-border);background:var(--chip-bg);color:var(--fg);text-decoration:none;font-weight:800}
    .auth-link:hover{border-color:var(--priB)}
    .avatar-wrapper{position:relative}
    .avatar-btn{display:flex;align-items:center;gap:10px;background:transparent;border:none;color:var(--fg);cursor:pointer}
    .avatar{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:700;overflow:hidden;background:linear-gradient(135deg,var(--pri1),var(--pri2))}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .avatar-initials{font-size:.95rem}
    .user-name{font-weight:700;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .menu{position:absolute;right:0;top:calc(100% + 8px);min-width:200px;background:var(--panel);border:1px solid var(--line-strong);border-radius:14px;box-shadow:0 16px 36px var(--shadow);display:none}
    .menu.show{display:block}
    .menu a,.menu button{display:flex;width:100%;gap:8px;align-items:center;padding:11px 14px;color:var(--fg);background:transparent;border:none;text-decoration:none;cursor:pointer;font-weight:700}
    .menu a:hover,.menu button:hover{background:var(--panel-2)}

    /* Toolbar */
    .toolbar{max-width:1200px;margin:0 auto;padding:12px 16px 0;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:.5rem .9rem;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-border);cursor:pointer;font-weight:700;color:var(--fg)}
    .chip[aria-pressed="true"],.chip:hover{background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);border-color:transparent}
    .right-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .select{appearance:none;padding:.55rem .8rem;border-radius:10px;background:var(--panel-2);border:1px solid var(--line-strong);color:var(--fg);font-weight:700;cursor:pointer}
    .order-btn{padding:.55rem .8rem;border-radius:10px;background:var(--panel-2);border:1px solid var(--line-strong);color:var(--fg);font-weight:700;cursor:pointer}

    /* Page + Cards */
    .page{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:18px;overflow:hidden;transition:.2s;backdrop-filter:blur(10px);position:relative;min-height:420px;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-4px);box-shadow:0 20px 40px var(--shadow);border-color:var(--line-strong)}
    .card .top{height:160px;background:linear-gradient(135deg,var(--card-top-1),var(--card-top-2));display:flex;align-items:center;justify-content:center;position:relative}
    .avatar-lg{width:74px;height:74px;border-radius:50%;background:linear-gradient(135deg,var(--pri1),var(--pri2));display:grid;place-items:center;font-weight:700}
    .avatar-lg img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .fav,.add-squad{position:absolute;top:10px;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);border:1px solid var(--line-strong);border-radius:999px;padding:6px;cursor:pointer}
    .fav{right:10px}
    .add-squad{right:52px}
    .fav.active{background:linear-gradient(135deg,#fde68a,#f59e0b);color:#111827}
    .card .body{padding:12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .name{font-weight:800;line-height:1.3;min-height:2.6em}

    .pos{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .6rem;border-radius:999px;background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);font-size:.74rem;font-weight:700;white-space:nowrap;width:fit-content;max-width:100%;align-self:flex-start}

    .stats{--stat-min:110px;display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--stat-min),1fr));gap:10px;margin:10px 0;align-items:stretch}
    .stat{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:72px;padding:10px;border-radius:12px;background:var(--panel-2);border:1px solid var(--line);min-width:0}
    .stat .val{font-weight:800;line-height:1;color:var(--priB)}
    .stat .lbl{margin-top:4px;font-size:12.5px;line-height:1.1;white-space:nowrap}

    .meta{margin-top:auto;display:flex;align-items:center;justify-content:space-between;padding-top:8px;border-top:1px solid var(--line)}
    .team{color:var(--muted);font-size:.92rem}
    .rating{display:flex;gap:6px;align-items:center;font-weight:700}
    .rating .val{color:var(--gold)}

    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:16px}
    .page-btn{min-width:34px;padding:.45rem .65rem;border-radius:10px;background:var(--panel-2);border:1px solid var(--line-strong);color:var(--fg);font-weight:700;cursor:pointer}
    .page-btn[disabled]{opacity:.5;cursor:not-allowed}
    .page-btn.active{background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);border-color:transparent}

    /* Toast */
    .toast{position:fixed;right:16px;top:16px;padding:10px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--line-strong);color:var(--fg);box-shadow:0 14px 36px var(--shadow);display:flex;gap:10px;align-items:center;transform:translateY(-12px);opacity:0;pointer-events:none;transition:.2s;z-index:9999}
    .toast.show{transform:translateY(0);opacity:1;pointer-events:auto}
    .toast__cta{padding:.45rem .8rem;border-radius:9px;border:1px solid var(--line-strong);background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);text-decoration:none;font-weight:900}
    .toast__close{background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:900}

    /* Footer */
    .footer{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line-strong);background:rgba(3,31,20,.85);backdrop-filter:blur(14px);z-index:1000;color:var(--fg)}
    [data-theme="light"] .footer{background:rgba(255,255,255,.85)}
    .footer-inner-row{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px}
    .f-left{display:flex;align-items:center;gap:8px;font-weight:800}
    .brand-mark{width:26px;height:26px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);font-weight:900}
    .brand-name{background:linear-gradient(135deg,var(--pri1),#4ade80);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-weight:900}
    .f-right{display:flex;align-items:center;gap:8px}
    .soc{display:grid;place-items:center;width:34px;height:34px;border-radius:10px;background:var(--panel-2);border:1px solid var(--line-strong);color:var(--fg);text-decoration:none}
    .soc:hover{background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);border-color:transparent}
    .back-top{display:inline-flex;align-items:center;gap:6px;padding:.4rem .7rem;border-radius:10px;background:var(--panel-2);border:1px solid var(--line-strong);color:var(--fg);font-weight:800;text-decoration:none}
    .back-top:hover{background:linear-gradient(135deg,var(--pri1),var(--pri2));color:var(--ink);border-color:transparent}
    .footer-login{padding:.4rem .7rem;border-radius:10px;border:1px solid var(--chip-border);background:var(--chip-bg);color:var(--fg);text-decoration:none;font-weight:800}
    .footer-login:hover{border-color:var(--priB)}

    /* MODAL squad */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:none;align-items:flex-start;justify-content:center;padding:16px 12px 90px;z-index:900}
    .modal.show{display:flex}
    .panel{width:min(1100px,100%);background:var(--panel);border:1px solid var(--line-strong);border-radius:16px;box-shadow:0 20px 50px var(--shadow);overflow:hidden}
    .panel-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line-strong);background:rgba(0,0,0,.05)}
    .panel-ttl{font-weight:800}
    .panel-bd{padding:12px}

    .pitch-wrap{max-height:65vh;overflow:auto;border-radius:12px;border:1px solid var(--line);background:#e9fff4}
    .pitch{position:relative;min-height:520px;padding:40px 16px}
    .pitch::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient( to bottom, rgba(16,185,129,.12) 0 80px, rgba(16,185,129,.2) 80px 160px );pointer-events:none}
    .slot{position:absolute;display:grid;place-items:center;width:160px;height:110px;border:2px dashed rgba(16,185,129,.45);border-radius:14px;background:rgba(255,255,255,.35);color:#0b3f24;font-weight:700;user-select:none;pointer-events:auto}
    .slot.taken{border-style:solid;background:rgba(16,185,129,.08)}
    .slot small{opacity:.75}

    /* Player chip on pitch */
    .pchip{position:absolute;transform:translate(-50%,-50%);min-width:140px;max-width:180px;background:linear-gradient(180deg,#0b3f2477,#063a2bbb);color:#eafff6;border:1px solid rgba(16,185,129,.35);border-radius:14px;padding:10px 12px;box-shadow:0 10px 22px rgba(0,0,0,.28);backdrop-filter:blur(6px);cursor:grab;user-select:none}
    .pchip:active{cursor:grabbing}
    .pchip .pname{font-weight:800}
    .pchip .ptag{display:inline-block;margin-bottom:6px;padding:2px 8px;border-radius:999px;background:#d1fae5;color:#065f46;font-weight:800;font-size:12px}

    /* Bench */
    .bench{margin-top:10px;border-top:1px dashed var(--line-strong);padding-top:10px}
    .bench-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel-2);margin-bottom:8px}
    .bench-act{margin-left:auto;display:flex;gap:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#d1fae5;color:#065f46;font-weight:800;font-size:12px}

    @media (max-width:520px){
      .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
      .slot{width:130px;height:96px}
      .pchip{min-width:120px}
    }
    @media (max-width:768px){
      .header-content{flex-direction:column;align-items:stretch}
      .searchbar{max-width:none}
      .brand-name{display:none}
      .user-name{max-width:120px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">⚽ FootballPro</div>

      <div class="searchbar" role="search">
        <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
        <input id="searchInput" type="text" placeholder="Search players (name/team/position)" aria-autocomplete="list" aria-controls="acList" aria-expanded="false"/>
        <button id="searchBtn" class="btn">Search</button>
        <div id="acList" class="ac" role="listbox" aria-label="Gợi ý tìm kiếm"></div>
      </div>

      <div class="auth-area" id="authArea">
        <a href="signin.html" id="loginLink" class="auth-link">Đăng nhập</a>
        <div class="avatar-wrapper" id="avatarWrap" style="display:none">
          <button class="avatar-btn" id="avatarBtn" aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
            <div class="avatar" id="avatar"><span class="avatar-initials">U</span></div>
            <span id="userNameText" class="user-name" style="display:none"></span>
          </button>
          <div class="menu" id="userMenu" role="menu" aria-label="User menu">
            <button id="themeToggle" class="toggle" role="menuitem">🌗 Dark / Light</button>
            <button id="logoutBtn" role="menuitem">🚪 Đăng xuất</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar" role="region" aria-label="Bộ lọc và sắp xếp">
    <div class="filters" role="group" aria-label="Bộ lọc vị trí">
      <button class="chip" data-position="all" aria-pressed="true">Tất cả</button>
      <button class="chip" data-position="Favorites" aria-pressed="false">❤️ Favorites</button>
      <button class="chip" data-position="GK" aria-pressed="false">GK</button>
      <button class="chip" data-position="DEF" aria-pressed="false">DEF</button>
      <button class="chip" data-position="MID" aria-pressed="false">MID</button>
      <button class="chip" data-position="FWD" aria-pressed="false">FWD</button>
    </div>

    <div class="right-tools">
      <button id="openSquad" class="btn-ghost">🧩 Đội hình của tôi</button>
      <label for="sortKey">Sort</label>
      <select id="sortKey" class="select" title="Tiêu chí sắp xếp">
        <option value="rating">Rating</option>
        <option value="goals">Goals</option>
        <option value="assists">Assists</option>
        <option value="matches">Matches</option>
        <option value="speed">Speed</option>
        <option value="name">Name</option>
        <option value="team">Team</option>
        <option value="position">Position</option>
      </select>
      <button id="sortDir" class="order-btn" aria-label="Đổi thứ tự tăng/giảm">⬍ ASC</button>

      <label for="perPage">Per page</label>
      <select id="perPage" class="select">
        <option value="8">8</option>
        <option value="12" selected>12</option>
        <option value="16">16</option>
        <option value="24">24</option>
      </select>
    </div>
  </div>

  <!-- Main -->
  <main class="page">
    <section id="playersGrid" class="grid" aria-live="polite" aria-busy="false"></section>
    <nav id="pagination" class="pagination" aria-label="Phân trang"></nav>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span id="toastMsg">Bạn cần đăng nhập để tìm kiếm.</span>
    <a id="toastCta" class="toast__cta" href="signin.html">Đăng nhập</a>
    <button id="toastClose" class="toast__close" aria-label="Đóng">×</button>
  </div>

  <!-- Squad Modal -->
  <div id="squadModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="panel-hd">
        <div class="panel-ttl">Đội hình của tôi (kéo thả để sắp xếp)</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="clearSquad" class="btn-ghost">Xoá đội hình</button>
          <button id="closeSquad" class="btn">Đóng</button>
        </div>
      </div>
      <div class="panel-bd">
        <div id="pitchWrap" class="pitch-wrap">
          <div id="pitch" class="pitch"></div>
        </div>

        <div class="bench">
          <div style="font-weight:800;margin-bottom:8px">Bench</div>
          <div id="benchList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer fixed -->
  <footer class="footer">
    <div class="footer-inner-row">
      <div class="f-left">
        <span class="brand-mark" aria-hidden="true">FP</span>
        <span class="brand-name">FootballPro</span>
        <span class="sep">•</span>
        <span>© <span id="y"></span></span>
      </div>
      <div class="f-right" id="footerLinks">
        <a href="signin.html" id="footerLoginBtn" class="footer-login">Đăng nhập</a>
        <a class="soc" href="#" aria-label="Facebook" title="Facebook">f</a>
        <a class="soc" href="#" aria-label="GitHub" title="GitHub">GH</a>
        <a class="back-top" href="#" id="backTop2" aria-label="Lên đầu trang">Top</a>
      </div>
    </div>
  </footer>

  <script>
    /* ========= Demo Data ========= */
    const players = [
      {name:"Lionel Messi",position:"FWD",team:"Inter Miami",rating:9.2,goals:28,assists:15,matches:32,speed:85,avatar:""},
      {name:"Kylian Mbappé",position:"FWD",team:"Real Madrid",rating:9.0,goals:35,assists:12,matches:38,speed:98,avatar:""},
      {name:"Erling Haaland",position:"FWD",team:"Manchester City",rating:8.9,goals:42,assists:8,matches:40,speed:89,avatar:""},
      {name:"Kevin De Bruyne",position:"MID",team:"Manchester City",rating:8.7,goals:12,assists:25,matches:35,speed:78,avatar:""},
      {name:"Virgil van Dijk",position:"DEF",team:"Liverpool",rating:8.5,goals:4,assists:3,matches:36,speed:82,avatar:""},
      {name:"Alisson Becker",position:"GK",team:"Liverpool",rating:8.4,goals:0,assists:1,matches:34,speed:65,avatar:""},
      {name:"Luka Modrić",position:"MID",team:"Real Madrid",rating:8.3,goals:6,assists:18,matches:33,speed:75,avatar:""},
      {name:"Robert Lewandowski",position:"FWD",team:"Barcelona",rating:8.6,goals:31,assists:9,matches:37,speed:79,avatar:""},
      {name:"Karim Benzema",position:"FWD",team:"Al-Ittihad",rating:8.2,goals:24,assists:11,matches:29,speed:80,avatar:""},
      {name:"N'Golo Kanté",position:"MID",team:"Al-Ittihad",rating:8.1,goals:3,assists:7,matches:28,speed:84,avatar:""},
      {name:"Sergio Ramos",position:"DEF",team:"PSG",rating:7.9,goals:5,assists:2,matches:31,speed:72,avatar:""},
      {name:"Thibaut Courtois",position:"GK",team:"Real Madrid",rating:8.3,goals:0,assists:0,matches:32,speed:68,avatar:""},
      {name:"Bukayo Saka",position:"FWD",team:"Arsenal",rating:8.2,goals:17,assists:12,matches:36,speed:90,avatar:""},
      {name:"Jude Bellingham",position:"MID",team:"Real Madrid",rating:8.8,goals:23,assists:10,matches:39,speed:86,avatar:""},
      {name:"Mohamed Salah",position:"FWD",team:"Liverpool",rating:8.7,goals:27,assists:11,matches:38,speed:91,avatar:""},
      {name:"Declan Rice",position:"MID",team:"Arsenal",rating:8.1,goals:6,assists:8,matches:37,speed:83,avatar:""},
      {name:"Antoine Griezmann",position:"FWD",team:"Atletico Madrid",rating:8.4,goals:22,assists:9,matches:37,speed:82,avatar:""},
      {name:"Marc-André ter Stegen",position:"GK",team:"Barcelona",rating:8.5,goals:0,assists:1,matches:34,speed:61,avatar:""},
      {name:"Ruben Dias",position:"DEF",team:"Manchester City",rating:8.3,goals:2,assists:3,matches:35,speed:76,avatar:""},
      {name:"Jamal Musiala",position:"MID",team:"Bayern Munich",rating:8.4,goals:16,assists:12,matches:34,speed:89,avatar:""}
    ];

    /* ========= Helpers & DOM ========= */
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const grid = $('#playersGrid');
    const pager = $('#pagination');
    const acList = $('#acList');
    const pitchWrap = $('#pitchWrap');
    const pitch = $('#pitch');
    const benchList = $('#benchList');

    // Toast
    const toast = $('#toast'), toastMsg = $('#toastMsg'), toastCta = $('#toastCta'), toastClose = $('#toastClose');
    function showToast(msg='Bạn cần đăng nhập để sử dụng.', cta='OK', href='#', ms=3500){
      toastMsg.textContent = msg; toastCta.textContent = cta; toastCta.href = href;
      toast.classList.add('show'); clearTimeout(showToast._t);
      if(ms>0) showToast._t = setTimeout(()=> toast.classList.remove('show'), ms);
    }
    toastClose.addEventListener('click', ()=> toast.classList.remove('show'));

    // Auth & per-user storage
    const LS = {
      auth:'auth', userName:'userName', userEmail:'userEmail',
      flt:'flt', qry:'qry', sortKey:'sortKey', sortDir:'sortDir', perPage:'perPage', page:'page',
      theme:'theme'
    };
    let isLoggedIn = localStorage.getItem(LS.auth) === '1';
    const loginLink = $('#loginLink'), avatarWrap = $('#avatarWrap'), avatarEl = $('#avatar'), userNameText = $('#userNameText'), footerLoginBtn = $('#footerLoginBtn');
    const userKey = ()=> {
      const raw = localStorage.getItem(LS.userEmail) || localStorage.getItem(LS.userName) || 'guest';
      return raw.toLowerCase().replace(/[^a-z0-9]/g,'_');
    };
    const keyFav = ()=> `favorites_${userKey()}`;
    const keyBench = ()=> `bench_${userKey()}`;
    const keySquad = ()=> `squad_${userKey()}`;

    function getInitials(x){ if(!x) return 'U'; const base = (x.includes('@')?x.split('@')[0]:x).trim(); const p=base.split(/\s+/); return p.length===1?base.slice(0,2).toUpperCase():(p[0][0]+p[p.length-1][0]).toUpperCase(); }
    function syncAuthUI(){
      if(isLoggedIn){
        loginLink.style.display='none'; avatarWrap.style.display='flex';
        const nm = localStorage.getItem(LS.userName) || localStorage.getItem(LS.userEmail) || 'User';
        avatarEl.innerHTML = `<span class="avatar-initials">${getInitials(nm)}</span>`;
        userNameText.textContent = nm; userNameText.style.display = 'inline';
        if(footerLoginBtn) footerLoginBtn.style.display = 'none';
      }else{
        avatarWrap.style.display='none'; loginLink.style.display='inline-flex'; userNameText.style.display='none';
        if(footerLoginBtn) footerLoginBtn.style.display = 'inline-flex';
      }
    }
    syncAuthUI();

    $('#avatarBtn')?.addEventListener('click',(e)=>{e.stopPropagation(); $('#userMenu').classList.toggle('show')});
    document.addEventListener('click', ()=> $('#userMenu')?.classList.remove('show'));
    $('#logoutBtn')?.addEventListener('click', ()=>{ localStorage.removeItem(LS.auth); localStorage.removeItem(LS.userName); localStorage.removeItem(LS.userEmail); isLoggedIn=false; syncAuthUI(); rerender(); });

    // Theme
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); }
    const savedTheme = localStorage.getItem(LS.theme) || 'dark'; applyTheme(savedTheme);
    $('#themeToggle')?.addEventListener('click', ()=>{ const t = (document.documentElement.getAttribute('data-theme')==='dark')?'light':'dark'; localStorage.setItem(LS.theme,t); applyTheme(t); });

    // Favorites per user
    let favorites = new Set(JSON.parse(localStorage.getItem(keyFav()) || '[]'));
    function saveFav(){ localStorage.setItem(keyFav(), JSON.stringify([...favorites])); }

    // UI state
    let currentFilter = localStorage.getItem(LS.flt) || 'all';
    let currentQuery  = localStorage.getItem(LS.qry) || '';
    let sortKey       = localStorage.getItem(LS.sortKey) || 'rating';
    let sortDir       = localStorage.getItem(LS.sortDir) || 'asc';
    let itemsPerPage  = parseInt(localStorage.getItem(LS.perPage) || '12', 10);
    let currentPage   = parseInt(localStorage.getItem(LS.page) || '1', 10);

    $('#searchInput').value = currentQuery; $('#sortKey').value = sortKey; $('#sortDir').textContent = (sortDir==='asc'?'⬍ ASC':'⬍ DESC'); $('#perPage').value = itemsPerPage;
    $$('.chip').forEach(c=> c.setAttribute('aria-pressed', String(c.dataset.position===currentFilter)));

    /* ========= List logic ========= */
    function baseFilter(){
      let list = [...players];
      if(currentFilter==='Favorites') list = list.filter(p => favorites.has(p.name));
      else if(currentFilter!=='all') list = list.filter(p => p.position === currentFilter);
      if(isLoggedIn && currentQuery.trim()){
        const s = currentQuery.toLowerCase();
        list = list.filter(p => p.name.toLowerCase().includes(s) || p.team.toLowerCase().includes(s) || p.position.toLowerCase().includes(s));
      }
      return list;
    }
    function sortList(list){
      const dir = (sortDir==='asc')?1:-1;
      return [...list].sort((a,b)=>{ let va=a[sortKey], vb=b[sortKey]; if(typeof va==='string') va=va.toLowerCase(); if(typeof vb==='string') vb=vb.toLowerCase(); if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0; });
    }
    function paginate(list){
      const total = list.length; const totalPages = Math.max(1, Math.ceil(total/itemsPerPage)); currentPage=Math.min(currentPage,totalPages); const start=(currentPage-1)*itemsPerPage;
      return { items:list.slice(start,start+itemsPerPage), totalPages };
    }
    function avatarContent(name, avatar){ if(avatar){return `<img loading="lazy" src="${avatar}" alt="${name}"/>`; } return `<span class="avatar-initials" aria-hidden="true">${name.split(' ').map(n=>n[0]).join('')}</span>`; }
    function card(p){
      const isFav = favorites.has(p.name);
      return `
        <article class="card" data-name="${p.name}">
          <div class="top">
            <div class="avatar-lg">${avatarContent(p.name, p.avatar)}</div>
            <button class="add-squad" title="Thêm vào đội hình" data-add="${p.name}">➕</button>
            <button class="fav ${isFav?'active':''}" title="Yêu thích" data-fav="${p.name}">❤️</button>
          </div>
          <div class="body">
            <div class="name">${p.name}</div>
            <span class="pos">${p.position}</span>
            <div class="stats">
              <div class="stat"><div class="val">${p.goals}</div><div class="lbl">Goals</div></div>
              <div class="stat"><div class="val">${p.assists}</div><div class="lbl">Assists</div></div>
              <div class="stat"><div class="val">${p.matches}</div><div class="lbl">Matches</div></div>
              <div class="stat"><div class="val">${p.speed}</div><div class="lbl">Speed</div></div>
            </div>
            <div class="meta">
              <span class="team">${p.team}</span>
              <div class="rating">⭐ <span class="val">${p.rating}</span></div>
            </div>
          </div>
        </article>
      `;
    }
    function renderGrid(rows){
      if(!rows.length){ grid.innerHTML = `<div style="opacity:.8;padding:20px;text-align:center;border:1px dashed var(--line);border-radius:12px">Không có kết quả phù hợp.</div>`; pager.innerHTML=''; return; }
      grid.innerHTML = rows.map(card).join('');
      // fav
      grid.querySelectorAll('.fav').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(!isLoggedIn){ showToast('Bạn cần đăng nhập để dùng Favorites.','Đăng nhập','signin.html'); return; }
          const name = btn.dataset.fav;
          const on = !favorites.has(name);
          if(on) favorites.add(name); else favorites.delete(name);
          saveFav(); btn.classList.toggle('active',on);
          showToast(on?`Đã thêm ${name} vào Favorites.`:`Đã bỏ ${name} khỏi Favorites.`,'OK','#',2000);
          if(currentFilter==='Favorites') rerender();
        });
      });
      // add to squad (to bench)
      grid.querySelectorAll('.add-squad').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(!isLoggedIn){ showToast('Đăng nhập để dùng Đội hình.','Đăng nhập','signin.html'); return; }
          const name = btn.dataset.add;
          addToBench(name);
          showToast(`Đã thêm ${name} vào Bench.`,'OK','#',2200);
        });
      });
      // ripple click
      grid.querySelectorAll('.card').forEach(c=>{
        c.addEventListener('click', ()=>{ c.style.transform='scale(.985)'; setTimeout(()=> c.style.transform='', 140); });
      });
    }
    function renderPager(totalPages){
      let html = `<button class="page-btn" ${currentPage===1?'disabled':''} data-act="prev" aria-label="Trang trước">«</button>`;
      const max=7; let st=Math.max(1,currentPage-Math.floor(max/2)); let en=Math.min(totalPages,st+max-1); if(en-st+1<max){st=Math.max(1,en-max+1);}
      for(let i=st;i<=en;i++){ html+=`<button class="page-btn ${i===currentPage?'active':''}" data-page="${i}" aria-current="${i===currentPage?'page':'false'}">${i}</button>`; }
      html += `<button class="page-btn" ${currentPage===totalPages?'disabled':''} data-act="next" aria-label="Trang sau">»</button>`;
      pager.innerHTML = html;
      pager.querySelectorAll('.page-btn').forEach(b=>{
        const act=b.getAttribute('data-act'), pg=b.getAttribute('data-page');
        b.addEventListener('click', ()=>{ if(act==='prev' && currentPage>1){currentPage--;rerender();return;} if(act==='next'){currentPage++;rerender();return;} if(pg){currentPage=parseInt(pg,10);rerender();} });
      });
    }
    function rerender(){
      // reload favorites for current user (in case switched account)
      favorites = new Set(JSON.parse(localStorage.getItem(keyFav()) || '[]'));
      const filtered=baseFilter(); const sorted=sortList(filtered); const {items,totalPages}=paginate(sorted);
      renderGrid(items); renderPager(totalPages);
      localStorage.setItem(LS.flt,currentFilter); localStorage.setItem(LS.qry,currentQuery); localStorage.setItem(LS.sortKey,sortKey); localStorage.setItem(LS.sortDir,sortDir); localStorage.setItem(LS.perPage,itemsPerPage); localStorage.setItem(LS.page,currentPage);
    }
    rerender();

    // Filters / Sort / PerPage
    $$('.chip').forEach(ch=> ch.addEventListener('click', ()=>{ $$('.chip').forEach(_=>_.setAttribute('aria-pressed','false')); ch.setAttribute('aria-pressed','true'); currentFilter=ch.dataset.position||'all'; currentPage=1; rerender(); }));
    $('#sortKey').addEventListener('change', e=>{ sortKey=e.target.value; currentPage=1; rerender(); });
    const sortDirBtn = $('#sortDir'); sortDirBtn.addEventListener('click', ()=>{ sortDir=(sortDir==='asc'?'desc':'asc'); sortDirBtn.textContent=(sortDir==='asc'?'⬍ ASC':'⬍ DESC'); currentPage=1; rerender(); });
    $('#perPage').addEventListener('change', e=>{ itemsPerPage=parseInt(e.target.value,10)||12; currentPage=1; rerender(); });

    // Search gating & actions
    const searchInput = $('#searchInput'); const searchBtn = $('#searchBtn');
    function requireLogin(){ if(!isLoggedIn){ showToast('Bạn cần đăng nhập để sử dụng tìm kiếm.','Đăng nhập','signin.html',5000); return false;} return true; }
    function doSearch(){ if(!requireLogin()) return; currentQuery=searchInput.value.trim(); currentPage=1; rerender(); }
    ['focus','click'].forEach(evt=> searchInput.addEventListener(evt, ()=>{ if(!isLoggedIn) showToast('Bạn cần đăng nhập để sử dụng tìm kiếm.','Đăng nhập','signin.html',4000); }));
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    // Autocomplete
    function renderAC(items){
      if(!items.length){ acList.classList.remove('show'); acList.innerHTML=''; searchInput.setAttribute('aria-expanded','false'); return; }
      acList.innerHTML = items.slice(0,8).map(p=>`
        <div class="ac-item" role="option" data-name="${p.name}">
          <div class="avatar" style="width:28px;height:28px;font-size:.8rem" aria-hidden="true">${getInitials(p.name)}</div>
          <div><div>${p.name}</div><div class="ac-pos">${p.team} • ${p.position}</div></div>
        </div>`).join('');
      acList.classList.add('show'); searchInput.setAttribute('aria-expanded','true');
      acList.querySelectorAll('.ac-item').forEach(it=> it.addEventListener('click', ()=>{ searchInput.value=it.dataset.name; acList.classList.remove('show'); searchInput.setAttribute('aria-expanded','false'); doSearch(); }));
    }
    searchInput.addEventListener('input', (e)=>{ const q=e.target.value.trim().toLowerCase(); if(!q){acList.classList.remove('show'); acList.innerHTML=''; searchInput.setAttribute('aria-expanded','false'); return;} if(!isLoggedIn){showToast('Đăng nhập để dùng gợi ý tìm kiếm.','Đăng nhập','signin.html',4000); acList.classList.remove('show'); return;} const list=players.filter(p=>p.name.toLowerCase().includes(q)||p.team.toLowerCase().includes(q)||p.position.toLowerCase().includes(q)); renderAC(list); });
    document.addEventListener('click', e=>{ if(!e.target.closest('.searchbar')){ acList.classList.remove('show'); searchInput.setAttribute('aria-expanded','false'); }});

    // Footer helpers
    document.getElementById('y').textContent = new Date().getFullYear();
    $('#backTop2')?.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); });

    /* ========= SQUAD: layout & drag ========= */
    const SLOTS = [
      {id:'LW',  x:18,  y:9},
      {id:'ST',  x:50,  y:9},
      {id:'RW',  x:82,  y:9},
      {id:'LDM', x:35,  y:37},
      {id:'CM',  x:50,  y:28},
      {id:'RDM', x:65,  y:37},
      {id:'LCB', x:35,  y:58},
      {id:'RCB', x:65,  y:58},
      {id:'LB',  x:18,  y:74},
      {id:'RB',  x:82,  y:74},
      {id:'GK',  x:50,  y:88},
    ];
    function slotRect(el){ const r=el.getBoundingClientRect(); return {l:r.left,t:r.top,w:r.width,h:r.height}; }

    // bench & squad state
    function loadBench(){ return JSON.parse(localStorage.getItem(keyBench()) || '[]'); }
    function saveBench(a){ localStorage.setItem(keyBench(), JSON.stringify(a)); }
    function loadSquad(){ return JSON.parse(localStorage.getItem(keySquad()) || '{}'); } // {slotId: playerName}
    function saveSquad(m){ localStorage.setItem(keySquad(), JSON.stringify(m)); }

    // build pitch
    function renderPitch(){
      pitch.innerHTML='';
      // slots
      SLOTS.forEach(s=>{
        const div=document.createElement('div');
        div.className='slot'; div.dataset.id=s.id;
        div.style.left = s.x+'%'; div.style.top = s.y+'%';
        div.innerHTML = `<small>+ ${s.id}</small>`;
        pitch.appendChild(div);
      });
      // chips from squad
      const squad = loadSquad();
      Object.entries(squad).forEach(([slotId, playerName])=>{
        const p = players.find(x=>x.name===playerName);
        if(p) placeChipToSlot(p, slotId);
      });
      markTaken();
    }
    function markTaken(){
      const squad = loadSquad();
      $$('.slot').forEach(s=> s.classList.toggle('taken', Boolean(squad[s.dataset.id])));
    }
    function centerOfSlot(el){
      const r  = el.getBoundingClientRect();
      const pr = pitch.getBoundingClientRect();
      return { x: r.left - pr.left + r.width/2, y: r.top - pr.top + r.height/2 };
    }
    function snapAllToSlots(){
      $$('.pchip').forEach(chip=>{
        const s = pitch.querySelector(`.slot[data-id="${chip.dataset.slot}"]`);
        if(!s) return;
        const c = centerOfSlot(s);
        chip.style.left = c.x + 'px';
        chip.style.top  = c.y + 'px';
      });
    }

    function chipEl(p){
      const el=document.createElement('div');
      el.className='pchip';
      el.innerHTML=`<div class="ptag">${p.position}</div><div class="pname">${p.name}</div><div style="font-size:12px;opacity:.85">${p.team} • ⭐ ${p.rating}</div>`;
      return el;
    }
    function placeChipToSlot(p, slotId){
      const slot = pitch.querySelector(`.slot[data-id="${slotId}"]`); if(!slot) return;
      // remove any existing chip sitting in this slot
      $$('.pchip').forEach(ch=>{ if(ch.dataset.slot===slotId) ch.remove(); });
      const el = chipEl(p);
      el.dataset.player = p.name; el.dataset.slot = slotId;
      pitch.appendChild(el);
      const c = centerOfSlot(slot);
      el.style.left = c.x+'px'; el.style.top = c.y+'px';
      enableDrag(el);
      const squad = loadSquad(); squad[slotId]=p.name; saveSquad(squad); markTaken();
    }

    // bench rendering
    function renderBench(){
      const bench = loadBench();
      benchList.innerHTML = bench.map(n=>{
        const p = players.find(x=>x.name===n); if(!p) return '';
        return `<div class="bench-item" data-name="${p.name}">
          <span class="pill">${p.position}</span>
          <div style="font-weight:700">${p.name}</div>
          <div style="opacity:.8">${p.team}</div>
          <div class="bench-act">
            <button class="btn-ghost" data-put="${p.name}">Mở sân</button>
            <button class="btn-ghost" data-rm="${p.name}">Gỡ</button>
          </div>
        </div>`;
      }).join('');
      benchList.querySelectorAll('[data-put]').forEach(b=> b.onclick=()=> openSelectSlot(b.dataset.put));
      benchList.querySelectorAll('[data-rm]').forEach(b=> b.onclick=()=> removeFromBench(b.dataset.rm));
    }
    function addToBench(name){
      const bench = loadBench(); if(!bench.includes(name)){ bench.push(name); saveBench(bench); renderBench(); }
    }
    function removeFromBench(name){
      const bench = loadBench().filter(x=>x!==name); saveBench(bench); renderBench();
    }
    function openSelectSlot(playerName){
      // chọn slot trống gần nhất theo vị trí (gợi ý), hoặc để người dùng kéo sau
      const empty = SLOTS.find(s=> !loadSquad()[s.id]);
      if(!empty){ showToast('Tất cả slot đã có người.','OK','#',2200); return; }
      const p = players.find(x=>x.name===playerName);
      placeChipToSlot(p, empty.id);
      showToast(`Đã thêm ${playerName} vào vị trí ${empty.id}.`,'OK','#',2200);
      removeFromBench(playerName);
    }

    // drag logic with auto-scroll inside pitchWrap
    function enableDrag(el){
      let ox=0, oy=0, dragging=false;
      function mm(ev){
        const pt = ('touches' in ev)? ev.touches[0] : ev;
        if(!dragging) return;
        let nx = pt.clientX - pitch.getBoundingClientRect().left - ox;
        let ny = pt.clientY - pitch.getBoundingClientRect().top  - oy;
        el.style.left = nx + 'px'; el.style.top = ny + 'px';

        // auto-scroll when near edges
        const wrapRect = pitchWrap.getBoundingClientRect();
        const edge = 60;
        if(pt.clientY < wrapRect.top + edge) pitchWrap.scrollTop -= 12;
        else if(pt.clientY > wrapRect.bottom - edge) pitchWrap.scrollTop += 12;
      }
      function mu(){
        if(!dragging) return;
        dragging=false; document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',mu);
        document.removeEventListener('touchmove',mm); document.removeEventListener('touchend',mu);

        // check drop on a slot
        const chipRect = el.getBoundingClientRect();
        let hit=null;
        $$('.slot').forEach(s=>{
          const r=s.getBoundingClientRect();
          const overlap = !(chipRect.right<r.left || chipRect.left>r.right || chipRect.bottom<r.top || chipRect.top>r.bottom);
          if(overlap) hit=s;
        });
        if(hit){
          const pName = el.dataset.player;
          const prevSlot = el.dataset.slot;
          // free previous slot
          const squad = loadSquad();
          if(prevSlot && squad[prevSlot]===pName) delete squad[prevSlot];
          // if target slot had player → send that player về bench
          if(squad[hit.dataset.id] && squad[hit.dataset.id]!==pName){
            addToBench(squad[hit.dataset.id]);
            $$('.pchip').forEach(c=>{ if(c.dataset.slot===hit.dataset.id) c.remove(); });
          }
          squad[hit.dataset.id] = pName; saveSquad(squad);
          el.dataset.slot = hit.dataset.id;
          const c=centerOfSlot(hit); el.style.left=c.x+'px'; el.style.top=c.y+'px';
          markTaken();
          showToast(`Đã thêm ${pName} vào vị trí ${hit.dataset.id}.`,'OK','#',2000);
        }else{
          // not dropped on slot -> snap về slot cũ
          const s = pitch.querySelector(`.slot[data-id="${el.dataset.slot}"]`);
          if(s){ const c=centerOfSlot(s); el.style.left=c.x+'px'; el.style.top=c.y+'px'; }
        }
      }
      el.addEventListener('mousedown', (e)=>{ dragging=true; const r=el.getBoundingClientRect(); ox = e.clientX - r.left - r.width/2; oy = e.clientY - r.top - r.height/2; document.addEventListener('mousemove',mm); document.addEventListener('mouseup',mu); });
      el.addEventListener('touchstart', (e)=>{ dragging=true; const t=e.touches[0]; const r=el.getBoundingClientRect(); ox = t.clientX - r.left - r.width/2; oy = t.clientY - r.top - r.height/2; document.addEventListener('touchmove',mm,{passive:false}); document.addEventListener('touchend',mu); }, {passive:true});
    }

    // Modal open/close & keep positions
    const modal = $('#squadModal');
    $('#openSquad').onclick = ()=>{
      if(!isLoggedIn){ showToast('Đăng nhập để mở đội hình.','Đăng nhập','signin.html'); return; }
      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
      renderPitch(); renderBench();
      requestAnimationFrame(()=> snapAllToSlots());
    };
    $('#closeSquad').onclick = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
    $('#clearSquad').onclick = ()=>{
      saveSquad({}); renderPitch(); showToast('Đã xoá toàn bộ đội hình.','OK','#',1800);
    };

    // Keep positions on resize as well
    let snapTimer; window.addEventListener('resize', ()=>{ clearTimeout(snapTimer); snapTimer=setTimeout(()=>{ if(modal.classList.contains('show')) snapAllToSlots(); }, 120); });
  </script>
</body>
</html>
